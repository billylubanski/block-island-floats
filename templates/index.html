{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<style>
    .geo-btn {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        background: var(--card-bg);
        border: 1px solid var(--accent);
        color: var(--accent);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 600;
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .geo-btn:hover {
        background: var(--accent);
        color: var(--bg-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="control-bar">
    <form action="/" method="get" style="display: flex; align-items: center; gap: 1rem; flex-grow: 1;">
        <label for="year" style="color: var(--text-secondary); font-weight: 600; white-space: nowrap;">Filter by
            Year:</label>
        <select id="year" name="year" onchange="this.form.submit()" style="min-width: 150px;">
            <option value="all" {% if selected_year=='all' %}selected{% endif %}>All Years</option>
            {% for row in years %}
            <option value="{{ row['year'] }}" {% if selected_year==row['year']|string %}selected{% endif %}>
                {{ row['year'] }}
            </option>
            {% endfor %}
        </select>
        <noscript><button type="submit">Apply</button></noscript>
    </form>
    <a href="https://www.blockislandinfo.com/glass-float-project/" target="_blank"
        style="background: var(--accent); color: var(--bg-color); padding: 0.5rem 0.75rem; border-radius: 0.5rem; text-decoration: none; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 0.25rem; margin-right: 1rem;">
        <span>üìù</span> Report Find
    </a>
    <div style="color: var(--text-secondary); font-size: 0.9rem;">
        Showing <strong>{{ total_finds }}</strong> floats {% if selected_year != 'all' %}found in <span
            style="color: var(--accent);">{{ selected_year }}</span>{% else %}across all years{% endif %}
    </div>
</div>

<div class="stat-grid">
    <div class="card stat-card">
        <div class="stat-value">{{ total_finds }}</div>
        <div class="stat-label">Total Floats Found</div>
    </div>
    <div class="card stat-card">
        <div class="stat-value">{{ years|length }}</div>
        <div class="stat-label">Years Tracked</div>
    </div>
    <div class="card stat-card">
        <div class="stat-value">{{ top_locs[0].name if top_locs else "N/A" }}</div>
        <div class="stat-label">Most Popular Spot</div>
    </div>
    <div class="card stat-card" style="border-color: var(--accent); background: rgba(80, 232, 168, 0.1);">
        <div class="stat-value" style="color: #fff;">
            {% if selected_year == 'all' %}
            {{ total_hidden_all_years - total_finds }}
            {% else %}
            {{ unreported_stats.unreported if unreported_stats else 0 }}
            {% endif %}
        </div>
        <div class="stat-label" style="color: var(--accent); font-weight: 700;">Still Out There! üéØ</div>
    </div>
</div>

<div class="card">
    <h2>Float Map</h2>
    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Heatmap showing concentration of finds across the
        island.</p>
    <div style="position: relative; height: 500px; width: 100%;">
        <div id="map" style="height: 100%; width: 100%; border-radius: 0.5rem; z-index: 1;"></div>
        <div id="map-loading" class="map-loading">
            <div class="spinner"></div>
            <div style="color: var(--text-secondary); font-weight: 600;">Loading Map...</div>
        </div>
        <button class="geo-btn" onclick="locateUser()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="3 11 22 2 13 21 11 13 3 11"></polygon>
            </svg>
            Geolocate Me
        </button>
    </div>
    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 1rem; text-align: center;">
        Last updated: {{ last_updated }}
    </p>
</div>

<div class="card">
    <h2>Top Hunting Grounds</h2>
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Based on historical data, these are the best
        trails
        to check.</p>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Location</th>
                    <th>Total Finds</th>
                    <th>Probability</th>
                </tr>
            </thead>
            <tbody>
                {% for loc in top_locs %}
                <tr>
                    <td>#{{ loop.index }}</td>
                    <td style="font-weight: 600; color: var(--text-primary);">
                        <a href="/location/{{ loc.name }}" style="color: var(--accent); text-decoration: none;">
                            {{ loc.name }}
                        </a>
                    </td>
                    <td>{{ loc.count }}</td>
                    <td>
                        <div
                            style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; width: 100px; display: inline-block; vertical-align: middle; margin-right: 10px;">
                            <div
                                style="background: var(--accent); height: 100%; border-radius: 3px; width: {{ [loc.count / total_finds * 100 * 5, 100] | min }}%;">
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card">
    <h2>Best Times to Hunt</h2>
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
        Based on {{ total_dates_analyzed }} dated finds, these are the most productive months.
    </p>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Month</th>
                    <th>Finds</th>
                    <th>Activity Level</th>
                </tr>
            </thead>
            <tbody>
                {% for month, count in best_months %}
                <tr>
                    <td style="font-weight: 600; color: var(--text-primary);">{{ month }}</td>
                    <td>{{ count }}</td>
                    <td>
                        <div
                            style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; width: 100px; display: inline-block; vertical-align: middle;">
                            <div
                                style="background: var(--accent); height: 100%; border-radius: 3px; width: {{ (count / best_months[0][1] * 100) if best_months else 0 }}%;">
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card">
    <h2>Finds by Year</h2>
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Historical trend showing float discoveries over
        recovery rates.</p>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Year</th>
                    <th>Hidden</th>
                    <th>Found</th>
                    <th style="width: 50%;">Recovery Rate</th>
                </tr>
            </thead>
            <tbody>
                {% for row in years %}
                <tr>
                    <td style="font-weight: 600; color: var(--text-primary);">{{ row['year'] }}</td>
                    <td style="color: var(--text-secondary);">{{ row['hidden'] }}</td>
                    <td>{{ row['found'] }}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div
                                style="background: rgba(255,255,255,0.1); height: 10px; border-radius: 5px; flex: 1; display: flex; align-items: center;">
                                <div
                                    style="background: linear-gradient(to right, var(--accent), #1A8672); height: 100%; border-radius: 5px; width: {{ row['recovery_rate'] if row['recovery_rate'] > 0 else 0 }}%; transition: width 0.3s ease;">
                                </div>
                            </div>
                            <span
                                style="color: var(--text-secondary); font-size: 0.875rem; min-width: 3rem; text-align: right;">
                                {{ row['recovery_rate'] | round(1) }}%
                            </span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    var map = L.map('map').setView([41.17, -71.58], 13);

    // Dark mode tiles
    var tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    });

    tiles.on('load', function () {
        var spinner = document.getElementById('map-loading');
        if (spinner) spinner.style.display = 'none';
    });

    // Fallback: Hide spinner after 3 seconds anyway
    setTimeout(function () {
        var spinner = document.getElementById('map-loading');
        if (spinner) spinner.style.display = 'none';
    }, 3000);

    tiles.addTo(map);

    // Prepare heatmap data
    var heatData = [
        {% for loc in top_locs %}
    {% if loc.lat and loc.lon %}
    [{{ loc.lat }}, {{ loc.lon }}, {{ loc.count / 10 }}],
        {% endif %}
    {% endfor %}
    ];

    // Add heatmap layer
    L.heatLayer(heatData, {
        radius: 25,
        blur: 35,
        maxZoom: 13,
        max: 50,
        gradient: {
            0.0: '#1A8672',
            0.5: '#50E8A8',
            1.0: '#1D5F9A'
        }
    }).addTo(map);

    // Also add top 30 markers for reference
    {% for loc in map_markers %}
    L.marker([{{ loc.lat }}, {{ loc.lon }}]).addTo(map)
        .bindPopup("<b>{{ loc.name }}</b><br>{{ loc.count }} finds");
    {% endfor %}

    // Geolocation function
    function locateUser() {
        if (!navigator.geolocation) {
            alert("Geolocation is not supported by your browser");
            return;
        }

        navigator.geolocation.getCurrentPosition(function (position) {
            var lat = position.coords.latitude;
            var lon = position.coords.longitude;

            // Add marker for user
            L.marker([lat, lon]).addTo(map)
                .bindPopup("You are here").openPopup();

            // Fly to user
            map.flyTo([lat, lon], 15);
        }, function () {
            alert("Unable to retrieve your location");
        });
    }
</script>
{% endblock %}